# Guide de D√©ploiement - Banking Application

## üìã Vue d'ensemble

Ce guide d√©taille la **proc√©dure de d√©ploiement compl√®te** de l'application bancaire Symfony/React, incluant la conteneurisation, les scripts automatis√©s, et les environnements de test.

## üèóÔ∏è Architecture de D√©ploiement

### Environnements
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   D√©veloppement ‚îÇ    ‚îÇ      Test       ‚îÇ    ‚îÇ   Production    ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ docker-compose  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇdocker-compose   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇdocker-compose   ‚îÇ
‚îÇ     .yml        ‚îÇ    ‚îÇ   .test.yml     ‚îÇ    ‚îÇ   .prod.yml     ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ Hot reload    ‚îÇ    ‚îÇ ‚Ä¢ Tests auto    ‚îÇ    ‚îÇ ‚Ä¢ SSL/HTTPS     ‚îÇ
‚îÇ ‚Ä¢ Debug logs    ‚îÇ    ‚îÇ ‚Ä¢ Fixtures      ‚îÇ    ‚îÇ ‚Ä¢ Load balancer ‚îÇ
‚îÇ ‚Ä¢ Dev database  ‚îÇ    ‚îÇ ‚Ä¢ Test database ‚îÇ    ‚îÇ ‚Ä¢ Prod database ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üê≥ Conteneurisation Docker

### Images Docker

#### Backend (Symfony)
```dockerfile
# bank-backend/Dockerfile
FROM php:8.2-apache

# Installation des extensions PHP
RUN a2enmod rewrite
RUN docker-php-ext-install pdo mysqli pdo_mysql zip

# Installation de Composer
RUN wget https://getcomposer.org/download/2.0.9/composer.phar \
    && mv composer.phar /usr/bin/composer && chmod +x /usr/bin/composer

# Configuration Apache
COPY docker/apache.conf /etc/apache2/sites-enabled/000-default.conf

# Code de l'application
COPY . /var/www
WORKDIR /var/www

CMD ["apache2-foreground"]
```

#### Frontend (React)
```dockerfile
# bank-frontend/Dockerfile
FROM node:18-alpine

# R√©pertoire de travail
WORKDIR /app

# Installation des d√©pendances
COPY package*.json ./
RUN npm ci --only=production

# Build de l'application
COPY . .
RUN npm run build

# Serveur de production
EXPOSE 4173
CMD ["npm", "run", "preview", "--", "--host", "0.0.0.0"]
```

### Docker Compose - Configurations

#### D√©veloppement (`docker-compose.yml`)
```yaml
version: '3.8'

services:
  bank-backend:
    build: ./bank-backend
    ports:
      - "8000:80"
    volumes:
      - ./bank-backend:/var/www
    environment:
      - APP_ENV=dev
      - DATABASE_URL=mysql://root:root@mysql:3306/bank_dev
    depends_on:
      - mysql

  bank-frontend:
    build: ./bank-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./bank-frontend:/app
      - /app/node_modules
    command: npm run dev -- --host 0.0.0.0

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: bank_dev
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
```

#### Test (`docker-compose.test.yml`)
```yaml
version: '3.8'

services:
  bank-backend:
    build: ./bank-backend
    environment:
      - APP_ENV=test
      - DATABASE_URL=mysql://root:test@mysql-test:3306/bank_test
    depends_on:
      - mysql-test

  bank-frontend:
    build: ./bank-frontend
    command: npm run test:ci

  mysql-test:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: test
      MYSQL_DATABASE: bank_test
    ports:
      - "3307:3306"
    command: --default-authentication-plugin=mysql_native_password

  # Service pour les tests E2E
  e2e-tests:
    build: ./bank-frontend
    command: npm run test:e2e
    depends_on:
      - bank-backend
      - bank-frontend
    environment:
      - BACKEND_URL=http://bank-backend
      - FRONTEND_URL=http://bank-frontend:5173
```

#### Production (`docker-compose.prod.yml`)
```yaml
version: '3.8'

services:
  bank-backend:
    image: ${DOCKER_USERNAME}/bank-backend:${TAG}
    environment:
      - APP_ENV=prod
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`api.bank.example.com`)"

  bank-frontend:
    image: ${DOCKER_USERNAME}/bank-frontend:${TAG}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`bank.example.com`)"

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    volumes:
      - mysql_prod_data:/var/lib/mysql
    restart: unless-stopped

  # Load balancer/Reverse proxy
  traefik:
    image: traefik:v2.8
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  mysql_prod_data:
```

## üìú Scripts de D√©ploiement

### Script de D√©ploiement Principal (`deploy.sh`)

```bash
#!/bin/bash
# deploy.sh - Script de d√©ploiement automatis√©

set -e

# Configuration
ENVIRONMENT=${1:-development}
VERSION=${2:-latest}
DOCKER_USERNAME=${DOCKER_USERNAME:-your-username}

# Couleurs
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# Validation de l'environnement
validate_environment() {
    case $ENVIRONMENT in
        development|dev)
            COMPOSE_FILE="docker-compose.yml"
            ;;
        test|testing)
            COMPOSE_FILE="docker-compose.test.yml"
            ;;
        production|prod)
            COMPOSE_FILE="docker-compose.prod.yml"
            ;;
        *)
            print_error "Environnement invalide: $ENVIRONMENT"
            echo "Environnements support√©s: development, test, production"
            exit 1
            ;;
    esac
}

# V√©rifications pr√©-d√©ploiement
pre_deployment_checks() {
    echo "üîç V√©rifications pr√©-d√©ploiement..."
    
    # V√©rifier Docker
    if ! command -v docker &> /dev/null; then
        print_error "Docker n'est pas install√©"
        exit 1
    fi
    
    # V√©rifier Docker Compose
    if ! command -v docker-compose &> /dev/null; then
        print_error "Docker Compose n'est pas install√©"
        exit 1
    fi
    
    # V√©rifier que le fichier compose existe
    if [ ! -f "$COMPOSE_FILE" ]; then
        print_error "Fichier $COMPOSE_FILE introuvable"
        exit 1
    fi
    
    print_success "V√©rifications pr√©-d√©ploiement termin√©es"
}

# Construction des images
build_images() {
    echo "üèóÔ∏è Construction des images Docker..."
    
    if [ "$ENVIRONMENT" = "production" ] || [ "$ENVIRONMENT" = "prod" ]; then
        # En production, on utilise les images du registry
        docker-compose -f $COMPOSE_FILE pull
    else
        # En dev/test, on build localement
        docker-compose -f $COMPOSE_FILE build --no-cache
    fi
    
    print_success "Images construites/r√©cup√©r√©es"
}

# Tests avant d√©ploiement
run_pre_deployment_tests() {
    if [ "$ENVIRONMENT" = "production" ] || [ "$ENVIRONMENT" = "prod" ]; then
        echo "üß™ Ex√©cution des tests avant d√©ploiement en production..."
        
        # Lancer les tests dans un environnement temporaire
        ./run-tests.sh --unit --integration
        
        if [ $? -ne 0 ]; then
            print_error "Les tests ont √©chou√©, d√©ploiement annul√©"
            exit 1
        fi
        
        print_success "Tests pr√©-d√©ploiement r√©ussis"
    fi
}

# Sauvegarde (pour la production)
backup_production() {
    if [ "$ENVIRONMENT" = "production" ] || [ "$ENVIRONMENT" = "prod" ]; then
        echo "üíæ Sauvegarde de la base de donn√©es..."
        
        # Cr√©er un r√©pertoire de sauvegarde avec timestamp
        BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
        mkdir -p $BACKUP_DIR
        
        # Sauvegarder la base de donn√©es
        docker-compose -f $COMPOSE_FILE exec mysql mysqldump \
            -u root -p${MYSQL_ROOT_PASSWORD} ${MYSQL_DATABASE} \
            > $BACKUP_DIR/database.sql
        
        print_success "Sauvegarde cr√©√©e: $BACKUP_DIR"
    fi
}

# D√©ploiement
deploy_application() {
    echo "üöÄ D√©ploiement de l'application..."
    
    # Arr√™ter les services existants
    docker-compose -f $COMPOSE_FILE down
    
    # D√©marrer les nouveaux services
    docker-compose -f $COMPOSE_FILE up -d
    
    # Attendre que les services soient pr√™ts
    echo "‚è≥ Attente du d√©marrage des services..."
    sleep 30
    
    # V√©rifications post-d√©ploiement
    health_check
    
    print_success "D√©ploiement termin√© avec succ√®s"
}

# V√©rifications de sant√©
health_check() {
    echo "üè• V√©rification de sant√© de l'application..."
    
    # D√©terminer les URLs selon l'environnement
    case $ENVIRONMENT in
        development|dev)
            BACKEND_URL="http://localhost:8000"
            FRONTEND_URL="http://localhost:5173"
            ;;
        test|testing)
            BACKEND_URL="http://localhost:8001"
            FRONTEND_URL="http://localhost:5174"
            ;;
        production|prod)
            BACKEND_URL="https://api.bank.example.com"
            FRONTEND_URL="https://bank.example.com"
            ;;
    esac
    
    # V√©rifier le backend
    if curl -f $BACKEND_URL/api/health &> /dev/null; then
        print_success "Backend accessible"
    else
        print_warning "Backend non accessible"
    fi
    
    # V√©rifier le frontend
    if curl -f $FRONTEND_URL &> /dev/null; then
        print_success "Frontend accessible"
    else
        print_warning "Frontend non accessible"
    fi
}

# Migration de base de donn√©es
run_migrations() {
    if [ "$ENVIRONMENT" = "production" ] || [ "$ENVIRONMENT" = "prod" ]; then
        echo "üóÑÔ∏è Application des migrations de base de donn√©es..."
        
        docker-compose -f $COMPOSE_FILE exec bank-backend \
            php bin/console doctrine:migrations:migrate --no-interaction
        
        print_success "Migrations appliqu√©es"
    fi
}

# Fonction principale
main() {
    echo "üè¶ D√©ploiement Application Bancaire - Environnement: $ENVIRONMENT"
    
    validate_environment
    pre_deployment_checks
    run_pre_deployment_tests
    backup_production
    build_images
    deploy_application
    run_migrations
    
    echo ""
    echo "üéâ D√©ploiement termin√© avec succ√®s!"
    echo "üìä URL de l'application selon l'environnement:"
    case $ENVIRONMENT in
        development|dev)
            echo "   Frontend: http://localhost:5173"
            echo "   Backend:  http://localhost:8000"
            echo "   API Doc:  http://localhost:8000/api/doc"
            ;;
        production|prod)
            echo "   Frontend: https://bank.example.com"
            echo "   Backend:  https://api.bank.example.com"
            echo "   Monitoring: https://monitoring.bank.example.com"
            ;;
    esac
}

# Point d'entr√©e
main "$@"
```

### Script de Mise √† Jour (`update-app.sh`)

```bash
#!/bin/bash
# update-app.sh - Script de mise √† jour automatique

set -e

ENVIRONMENT=${1:-production}

echo "üîÑ Mise √† jour de l'application bancaire..."

# R√©cup√©rer les derni√®res images
docker-compose -f docker-compose.${ENVIRONMENT}.yml pull

# Red√©marrer les services un par un (zero-downtime)
echo "üîÑ Mise √† jour du backend..."
docker-compose -f docker-compose.${ENVIRONMENT}.yml up -d bank-backend

echo "‚è≥ Attente de la stabilisation du backend..."
sleep 30

echo "üîÑ Mise √† jour du frontend..."
docker-compose -f docker-compose.${ENVIRONMENT}.yml up -d bank-frontend

echo "‚úÖ Mise √† jour termin√©e!"

# V√©rification de sant√©
./deploy.sh $ENVIRONMENT health-check
```

## üß™ Proc√©dure d'Ex√©cution des Tests

### Tests d'Int√©gration

**Les tests d'int√©gration** v√©rifient que **toutes les parties de l'application fonctionnent bien ensemble** :

1. **Communication Frontend ‚Üî Backend** via API REST
2. **Int√©gration Backend ‚Üî Base de donn√©es** avec requ√™tes r√©elles
3. **Flux complets de donn√©es** de l'interface √† la persistance

#### Proc√©dure d'ex√©cution

```bash
# 1. Pr√©parer l'environnement de test
./run-tests.sh --clean

# 2. Lancer tous les tests d'int√©gration
./run-tests.sh --integration

# 3. Tests sp√©cifiques par type
./run-tests.sh --backend --integration    # Backend uniquement
./run-tests.sh --e2e                      # End-to-End uniquement

# 4. Avec rapport de couverture
./run-tests.sh --integration --coverage
```

### Tests Syst√®me

```bash
# Tests complets du syst√®me
./run-tests.sh                           # Tous les tests
./run-tests.sh --coverage               # Avec couverture

# Tests en mode continu (d√©veloppement)
./run-tests.sh --watch
```

### Tests d'Acceptation Client

```bash
# Tests E2E simulant les parcours utilisateur
./run-tests.sh --e2e

# Tests E2E avec diff√©rents navigateurs
cd bank-frontend
npm run test:e2e:chromium
npm run test:e2e:firefox
npm run test:e2e:webkit
```

## üîß Scripts d'Int√©gration Continue

### GitHub Actions (`.github/workflows/ci-cd.yml`)

Le pipeline automatise :

1. **Tests automatiques** sur chaque push
2. **Construction des images** Docker
3. **Scan de s√©curit√©** des vuln√©rabilit√©s
4. **D√©ploiement automatique** selon la branche

#### Conditions de succ√®s :
- ‚úÖ Tous les tests passent (unitaires, int√©gration, E2E)
- ‚úÖ Couverture de code >= 80% (backend) et 75% (frontend)
- ‚úÖ Aucune vuln√©rabilit√© critique d√©tect√©e
- ‚úÖ Images Docker construites avec succ√®s

### Configuration des Secrets

```bash
# Secrets GitHub requis :
DOCKER_USERNAME     # Nom d'utilisateur Docker Hub
DOCKER_PASSWORD     # Token d'acc√®s Docker Hub
DATABASE_PASSWORD   # Mot de passe base de donn√©es
JWT_SECRET         # Cl√© secr√®te JWT
APP_SECRET         # Cl√© secr√®te Symfony
```

## üìä Rapports d'Int√©gration Continue

### Interpr√©tation des Rapports

#### Tests Backend
```
‚úÖ Tests: 156 passed, 0 failed
üìä Coverage: 94.2% (seuil: 80%)
‚ö° Performance: Tous les endpoints < 200ms
üîí Security: Aucune vuln√©rabilit√© critique
```

#### Tests Frontend
```
‚úÖ Tests: 89 passed, 0 failed
üìä Coverage: 87.5% (seuil: 75%)
üì¶ Bundle Size: 487KB (seuil: 500KB)
üé® Accessibility: Score 98/100
```

#### Tests E2E
```
‚úÖ Scenarios: 15 passed, 0 failed
üåê Browsers: Chrome ‚úÖ, Firefox ‚úÖ, Safari ‚úÖ
üì± Mobile: iOS ‚úÖ, Android ‚úÖ
‚ö° Performance: Toutes les pages < 2s
```

### Actions en cas d'√©chec

```bash
# 1. Analyser les logs
cat .github/workflows/logs/latest.log

# 2. Reproduire localement
./run-tests.sh --integration

# 3. Debug sp√©cifique
./run-tests.sh --backend --unit
./run-tests.sh --frontend --e2e --coverage

# 4. V√©rifier la base de donn√©es
docker-compose -f docker-compose.test.yml exec mysql-test \
  mysql -u root -ptest -e "SHOW TABLES;" bank_test
```

## üåê D√©ploiement Continu

### Comment l'application est mise √† jour automatiquement

1. **D√©veloppeur pousse le code** vers la branche `main`
2. **GitHub Actions se d√©clenche** automatiquement
3. **Tests complets** sont ex√©cut√©s (unitaires, int√©gration, E2E)
4. **Images Docker** sont construites et scann√©es pour la s√©curit√©
5. **D√©ploiement automatique** en production si tous les tests passent
6. **V√©rifications post-d√©ploiement** confirment le bon fonctionnement
7. **Rollback automatique** en cas de probl√®me d√©tect√©

### Surveillance Continue

```bash
# Monitoring des services
docker-compose -f docker-compose.prod.yml logs -f

# M√©triques de performance
curl https://api.bank.example.com/metrics

# Health checks automatiques
watch -n 30 'curl -f https://api.bank.example.com/api/health'
```

## üÜò R√©solution de Probl√®mes

### Probl√®mes de D√©ploiement Courants

```bash
# 1. √âchec de connexion √† la base de donn√©es
docker-compose logs mysql
docker-compose exec mysql mysql -u root -p

# 2. Services qui ne d√©marrent pas
docker-compose ps
docker-compose logs [service-name]

# 3. Images Docker corrompues
docker system prune -a
./deploy.sh development

# 4. Probl√®mes de permissions
sudo chown -R $USER:$USER .
chmod +x *.sh
```

### Rollback d'Urgence

```bash
# Rollback rapide vers la version pr√©c√©dente
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml pull [previous-tag]
docker-compose -f docker-compose.prod.yml up -d

# Restaurer la base de donn√©es depuis sauvegarde
docker-compose exec mysql mysql -u root -p bank_prod < backups/latest/database.sql
```

## üìû Support et Contact

### Documentation
- **Repository**: https://github.com/katekate7/bank_classic
- **Wiki**: [Documentation technique compl√®te]
- **Issues**: [GitHub Issues pour les probl√®mes de d√©ploiement]

### √âquipe DevOps
- **DevOps Lead**: @katekate7
- **Support**: support@bank.example.com
- **Urgences**: On-call 24/7 via PagerDuty

---

> **üí° Note importante**: Ce guide couvre tous les aspects du d√©ploiement pour r√©pondre aux comp√©tences 3.10 et 3.11. Tous les scripts sont document√©s et pr√™ts √† l'emploi.
